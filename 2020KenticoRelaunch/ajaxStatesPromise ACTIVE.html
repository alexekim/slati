<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous" type="text/javascript"></script>
<style media="screen" type="text/css">.description {
    white-space: pre-line;
  }

  .info {
    display: none;
  }

  hr {
    display: none;
  }

  .category h4,
  .category p {
    /*margin-left: 20px;*/
  }

  .backToTop {
    display: none;
    color: #3a75c4;
    margin-bottom: 20px;
  }

  .backToTop:hover {
    text-decoration: underline;
    cursor: pointer;
  }

  .sectionHeaderh2 {
    /* color: red !important; */
  }

  .citation {
    font-size: 14px !important;
    font-style: italic !important;
  }

  .smokingRestrictions,
  .tobaccoTaxes,
  .tobaccoProductSalesRestrictions,
  .tobaccoControlProgramFunding,
  .lawsRestrictingYouthAccess,
  .tobaccoProductSamples,
  .salesOfTobaccoProductsFromVendingMachines,
  .licensingRequirements,
  .smokingProtectionLaws,
  .advertisingAndPromotion,
  .productDisclosure,
  .divestment,
  .liability,
  .useOfTobaccoSettlementDollars,
  .fireSafetyStandards,
  .preemption,
  .activity {
    display: none;
  }


  .topSlati {
    border: 5px solid #e3e3e3;
    padding: 20px;
    margin-bottom: 35px;
    border-radius: 20px 0px 20px 0px;
  }
  #changeState {
    float: right;
  }

  #toc {
    margin: 20px 0 20px 0;
    width: 50%;
    padding: 10px;
    font-family: 'Lato', sans-serif;
  }

  @media (max-width: 500px) {
    #changeState {
      float: none;
      margin-top: 20px;
    }
  }
</style>
<div id="loadSpinner" style="text-align:center;"><img src="/getmedia/68cdad06-3207-488d-a06c-6180ee7ec539/spinner.gif" style="margin: 0 auto; height: 50px; width: 50px;" />
<p style="text-align: center;">Loading...</p>
</div>

<div class="info">
<div class="topSlati">
<h2 id="state">&nbsp;</h2>

<div id="changeState"><a class="btn" id="viewDiff">View a different state</a></div>
<script type="text/javascript">
      $("#viewDiff").on("click", function(){
        document.getElementsByClassName('header-info-location js-location-modal')[0].click();
      });
    </script><select id="toc" name=""><option value="#">Jump to...</option><option value="#smokingRestrictions">Smoking Restrictions</option><option value="#tobaccoTaxes">Tobacco Taxes</option><option value="#tobaccoControlProgramFunding">Tobacco Control Program Funding</option><option value="#tobaccoProductSalesRestrictions">Tobacco Product Sales Restrictions</option><option value="#licensingRequirements">Licensing Requirements</option><option value="#smokingProtectionLaws">Smoking Protection Laws</option><option value="#advertisingAndPromotion">Advertising &amp; Promotion</option><option value="#productDisclosure">Product Disclosure</option><option value="#divestment">Divestment</option><option value="#liability">Liability</option><option value="#useOfTobaccoSettlementDollars">Use of Tobacco Settlement Dollars</option><option value="#fireSafetyStandards">Fire Safety Standards for Cigarettes</option><option value="#preemption">Preemption</option><option value="#activity">Activity</option> </select> <script type="text/javascript">
      $("#toc").on("change", function() {
        window.location = $(this).val();
      })
    </script></div>
<!-- <p>
    <a href="#smokingRestrictions">Smoking Restrictions</a>
    <br/>
    <a href="#tobaccoTaxes">Tobacco Taxes</a>
    <br/>
    <a href="#tobaccoControlProgramFunding">Tobacco Control Program Funding</a>
    <br/>
    <a href="#lawsRestrictingYouthAccess">Laws Restricting Youth Access to Tobacco Products</a>
    <br/>
    <a href="#tobaccoProductSamples">Tobacco Product Samples/Minimum Sales Amounts for Tobacco Products</a>
    <br/>
    <a href="#salesOfTobaccoProductsFromVendingMachines">Sales of Tobacco Products from Vending Machines</a>
    <br/>
    <a href="#licensingRequirements">Licensing Requirements for Tobacco Products</a>
    <br/>
    <a href="#smokingProtectionLaws">Smoking Protection Laws</a>
    <br/>
    <a href="#advertisingAndPromotion">Advertising &amp; Promotion</a>
    <br/>
    <a href="#productDisclosure">Product Disclosure</a>
    <br/>
    <a href="#divestment">Divestment</a>
    <br/>
    <a href="#liability">Liability</a>
    <br/>
    <a href="#useOfTobaccoSettlementDollars">Use of Tobacco Settlement Dollars</a>
    <br/>
    <a href="#fireSafetyStandards">Fire Safety Standards for Cigarettes</a>
    <br/>
    <a href="#activity">Activity</a>
    <br/>
  </p> --><a name="smokingRestrictions"></a>

<div class="category smokingRestrictions">
<h2 class="sectionHeaderh2">Smoking Restrictions</h2>
</div>
<!--<hr/>--> <a name="tobaccoTaxes"></a>

<div class="category tobaccoTaxes">
<h2 class="sectionHeaderh2">Tobacco Taxes</h2>
</div>
<!--<hr/>--> <a name="tobaccoControlProgramFunding"></a>

<div class="category tobaccoControlProgramFunding">
<h2 class="sectionHeaderh2">Tobacco Control Program Funding</h2>
</div>
<!--<hr/>--> <a name="tobaccoProductSalesRestrictions"></a>

<div class="category tobaccoProductSalesRestrictions">
<h2 class="sectionHeaderh2">Tobacco Product Sales Restrictions</h2>
</div>
<a name="licensingRequirements"></a>

<div class="category licensingRequirements">
<h2 class="sectionHeaderh2">Licensing Requirements for Tobacco Products</h2>
</div>
<!--<hr/>--> <a name="smokingProtectionLaws"></a>

<div class="category smokingProtectionLaws">
<h2 class="sectionHeaderh2">Smoking Protection Laws</h2>
</div>
<!--<hr/>--> <a name="advertisingAndPromotion"></a>

<div class="category advertisingAndPromotion">
<h2 class="sectionHeaderh2">Advertising &amp; Promotion</h2>
</div>
<!--<hr/>--> <a name="productDisclosure"></a>

<div class="category productDisclosure">
<h2 class="sectionHeaderh2">Product Disclosure</h2>
</div>
<!--<hr/>--> <a name="divestment"></a>

<div class="category divestment">
<h2 class="sectionHeaderh2">Divestment</h2>
</div>
<!--<hr/>--> <a name="liability"></a>

<div class="category liability">
<h2 class="sectionHeaderh2">Liability</h2>
</div>
<!--<hr/>--> <a name="useOfTobaccoSettlementDollars"></a>

<div class="category useOfTobaccoSettlementDollars">
<h2 class="sectionHeaderh2">Use of Tobacco Settlement Dollars</h2>
</div>
<!--<hr/>--> <a name="fireSafetyStandards"></a>

<div class="category fireSafetyStandards">
<h2 class="sectionHeaderh2">Fire Safety Standards for Cigarettes</h2>
</div>
<!--<hr/>--> <a name="preemption"></a>

<div class="category preemption">
<h2 class="sectionHeaderh2">Preemption</h2>
</div>
<!--<hr/>--> <a name="activity"></a>

<div class="category activity">
<h2 class="sectionHeaderh2">Recent Legislative Activity</h2>
</div>
<!--<hr/>--></div>
<script type="text/javascript">
  var exceptions = {
    "one" : {"subcategory": "", "description": "", "citation": ""},
    "two" : {"subcategory": "", "description": "", "citation": ""},
    "three" : {"subcategory": "", "description": "", "citation": ""}
  };

  var xmlSort = function(){
    exceptions = {
      "one" : {"subcategory": "", "description": "", "citation": ""},
      "two" : {"subcategory": "", "description": "", "citation": ""},
      "three" : {"subcategory": "", "description": "", "citation": ""}
    }; // clearing out any previous changes to this global object

    return new Promise(function(resolve, reject){
      var cookieArray = document.cookie.split(";")
      if(document.cookie.includes("StateCode=")){
        for (var i = 0; i < cookieArray.length; i++) {
          if(!cookieArray[i].includes("StateCode=")){
            // //console.log("not it");
            continue;
          } else {
            // //console.log("yep this is it");
            var currentState = cookieArray[i].split("=")[1];
            // //console.log(currentState);
            break;
          }
        }
      }

      if (!currentState) {
        console.warn("no state assigned. assigning DC");
        var currentState = "DC";
      }

      var url = "~/Content/xml/slati/" + currentState + ".xml";
      // var url = "/getmedia/31aa66df-be0d-42a1-9d4c-a8ab88221708/AZ.xml"

      //console.log("current state is: " + currentState);
      $.ajax({
        type: "GET",
        url: url,
        dataType: "xml",
        success: function(xml) {
          //console.log(xml);
          $("#loadSpinner").css("display", "none");
          $(".info").css("display", "block");
          // $("hr").css("display", "block");
          $(".backToTop").css("display", "block");
          $(".subcategory").remove();
          $(".description").remove();
          $(".citation").remove();
          // var asdf = $(xml).find('Category');
          // //console.log(asdf);
          $(xml).find('qryXMLSLATIDetail').each(function(i) {
            var Name = $(this).find('Name').text();
            // if ($("#state").html() == "") {
              $("#state").html(Name);
            // }
            var Abbrev = $(this).find('Abbrev').text();
            // var FipsCode = $(this).find('FipsCode').text();
            // var HasLawOrRestriction = $(this).find('HasLawOrRestriction').text();
            // var HasLawOrRestrictionDescription = $(this).find('HasLawOrRestrictionDescription').text();
            // var CategoryDisplayOrder = $(this).find('CategoryDisplayOrder').text();
            // var SubcategoryDisplayOrder = $(this).find('SubcategoryDisplayOrder').text();
            // var SubcategoryID = $(this).find('SubcategoryID').text();
            // var CategoryID = $(this).find('CategoryID').text();
            // var StateID = $(this).find('StateID').text();
            var Category = $(this).find('Category').text();
            var Subcategory = $(this).find('Subcategory').text();
            var Description = $(this).find('Description').text();
            var Citation = $(this).find('Citation').text();
            var year = $(this).find('Year').text();

            // //console.log("DESCRIPTION", Description);
            // //console.log("CAT:", Category, "\n SUB:", Subcategory, "\n  DESC:", Description, "\n YEAR:", year);

            if(Description.length && Description != " "){
              // //console.log("description DOES exist for category,", Category, "subcategory: ", Subcategory);
              switch (Category) {
                case "Smoking Restrictions":
                if(Subcategory == "Retail/Grocery Stores" || Subcategory == "Arts/Cultural Facilities" || Subcategory == "Gymnasiums/Arenas") {
                  break;
                } else {
                  $(".smokingRestrictions").show();
                  $(".smokingRestrictions").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                    $(".smokingRestrictions").append("<p class='description'>" + Description + "</p>");
                    $(".smokingRestrictions").append("<p class='citation'>" + Citation + "</p>");
                    break;
                }
                case "Tobacco Taxes":
                if(Subcategory == "Tax on Cigarettes - Last Changed"){
                  break;
                } else {
                  $(".tobaccoTaxes").show();
                  $(".tobaccoTaxes").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                  $(".tobaccoTaxes").append("<p class='description'>" + Description + "</p>");
                  $(".tobaccoTaxes").append("<p class='citation'>" + Citation + "</p>");
                }
                break;
                case "Tobacco Control Program Funding":
                if(Subcategory == "Funding for Tobacco Control Programs"){
                  exceptions.three.subcategory = Subcategory;
                  exceptions.three.description = Description;
                  exceptions.three.citation = Citation;
                  // prepend this to this category
                } else if(Subcategory == "State Settlement Expenditures" || Subcategory == "State Tax Expenditures" || Subcategory == "State Other Expenditures" || Subcategory == "Federal/CDC Funding" || Subcategory == "CDC Best Practice Rate" ){
                  break;
                } else {
                  $(".tobaccoControlProgramFunding").show();
                  $(".tobaccoControlProgramFunding").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                  $(".tobaccoControlProgramFunding").append("<p class='description'>" + Description + "</p>");
                  $(".tobaccoControlProgramFunding").append("<p class='citation'>" + Citation + "</p>");
                }
                break;
                case "Tobacco Product Sales Restrictions":
                $(".tobaccoProductSalesRestrictions").show();
                $(".tobaccoProductSalesRestrictions").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".tobaccoProductSalesRestrictions").append("<p class='description'>" + Description + "</p>");
                $(".tobaccoProductSalesRestrictions").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Licensing Requirements":
                $(".licensingRequirements").show();
                $(".licensingRequirements").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".licensingRequirements").append("<p class='description'>" + Description + "</p>");
                $(".licensingRequirements").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Smoking Protection Laws":
                $(".smokingProtectionLaws").show();
                $(".smokingProtectionLaws").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".smokingProtectionLaws").append("<p class='description'>" + Description + "</p>");
                $(".smokingProtectionLaws").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Advertising and Promotion":
                $(".advertisingAndPromotion").show();
                $(".advertisingAndPromotion").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".advertisingAndPromotion").append("<p class='description'>" + Description + "</p>");
                $(".advertisingAndPromotion").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Product Disclosure of Tobacco Products":
                $(".productDisclosure").show();
                $(".productDisclosure").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".productDisclosure").append("<p class='description'>" + Description + "</p>");
                $(".productDisclosure").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Divestment":
                $(".divestment").show();
                $(".divestment").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".divestment").append("<p class='description'>" + Description + "</p>");
                $(".divestment").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Liability":
                if (Subcategory != "Liability State Law Citation") {
                  $(".liability").show();
                  $(".liability").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                  $(".liability").append("<p class='description'>" + Description + "</p>");
                  $(".liability").append("<p class='citation'>" + Citation + "</p>");
                }
                break;
                case "Use of Tobacco Settlement Dollars":
                $(".useOfTobaccoSettlementDollars").show();
                $(".useOfTobaccoSettlementDollars").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".useOfTobaccoSettlementDollars").append("<p class='description'>" + Description + "</p>");
                $(".useOfTobaccoSettlementDollars").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Fire Safety Standards for Cigarettes":
                $(".fireSafetyStandards").show();
                $(".fireSafetyStandards").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".fireSafetyStandards").append("<p class='description'>" + Description + "</p>");
                $(".fireSafetyStandards").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Preemption":
                $(".preemption").show();
                $(".preemption").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                $(".preemption").append("<p class='description'>" + Description + "</p>");
                $(".preemption").append("<p class='citation'>" + Citation + "</p>");
                break;
                case "Activity":
                if(year >= 2021){ // only display Year 2019 or greater "more recent"
                  $(".activity").show();
                  // $(".activity").append("<h5 class='subcategory'>" + Subcategory +"</h5>");
                  $(".activity").append("<p class='description'>" + Description + "</p>");
                  $(".activity").append("<p class='citation'>" + Citation + "</p>");
                }
                break;
                default:
                console.warn("something went wrong in the content sort. maybe no category exists. category:", Category);
              } // end switch
            } else {
              //console.log(`Category: ${Category}, Subcategory: ${Subcategory} : NO DESCRIPTION IN XML.`);
            } // end if Description exists
          });

          var changeStateDiv = '<div id="changeState"><a id="viewDiff" class="btn" onclick="document.getElementsByClassName(\'header-info-location js-location-modal\')[0].click()">View a different state</a></div>';
          $("#changeState").remove();
          if ($("#changeState").length < 1) {
            $("#state").append(changeStateDiv);
          }
          $("hr").css("display", "block");

          resolve(exceptions);
        }, //end success
        error: function(err) {
          console.warn("An error occurred while processing SLATI XML file.");
          $("#loadSpinner").html("<p style='color: red;'>Error loading. Please refresh the page.</p>");
          reject(err);
        }
      });
    }) //end promise
  } //end xmlSort

  var fixCitations = function(){
    var allDescriptions = document.getElementsByClassName("description");
    for (var i = 0; i < allDescriptions.length; i++) {
      var x = allDescriptions[i].innerHTML;
      var array = x.split("\n");
      for (var j = 0; j < array.length; j++) {
        // if ( /\d{4}/.test(array[j]) || array[j].includes("§") ) {

        // if ( array[j].includes("§") || array[j].includes("ILL.COMP") || array[j].includes("ILL. COMP.") || array[j].includes("IL. COMP") || array[j].includes("IL COMP") || array[j].includes('FLA STA') || array[j].includes('FLA. STA') ) {
        //   array[j] = "<span class='citation'>" + array[j] + "</span>";
        // }

        let citationCase = ["§", "ILL.COMP", "ILL. COMP.", "IL. COMP", "IL COMP", 'FLA STA', 'FLA. STA', 'LA CONST', 'OK CONST' ];
        let trueOrFalse = citationCase.some(i => array[j].includes(i));
        if(trueOrFalse){
          array[j] = "<span class='citation'>" + array[j] + "</span>";
        }
      }
      array = array.join("\n");
      allDescriptions[i].innerHTML = array;
    }
  }

  //maryland has a line with "§" that should not have citation format
  const fixCitationsPost = () => {
    let allCitations = document.querySelectorAll(".citation");
    for (var i = 0; i < allCitations.length; i++) {
      //console.log(allCitations[i]);
      if(allCitations[i].innerHTML.includes("Premium Cigars (as defined in Maryland Business Regulation code ") || allCitations[i].innerHTML.includes("§ 5702") || allCitations[i].innerHTML.includes("39-57-01")){
        allCitations[i].setAttribute("class", "");
      }
    }
  };

  var handleResolve = function(exceptions){
    //console.log("promise resolved,", exceptions);
    $(".lawsRestrictingYouthAccess h2").after("<h5 class='subcategory'>" + exceptions.one.subcategory + "</h4>" + "<p class='description'>" + exceptions.one.description + "</p>" + "<p class='citation'>" + exceptions.one.citation + "</p>"); //subcategory
    // $(".lawsRestrictingYouthAccess h2").after("<p class='description'>" + exceptions.one.description + "</p>"); //description
    // $(".lawsRestrictingYouthAccess h2").after("<p class='citation'>" + exceptions.one.citation + "</p>"); //citation

    $("#signPosting").before("<h5 class='subcategory'>" + exceptions.two.subcategory + "</h4>" + "<p class='description'>" + exceptions.two.description + "</p>" + "<p class='citation'>" + exceptions.two.citation + "</p>" );//subcategory
    // $("#signPosting").before("<p class='description'>" + exceptions.two.description + "</p>"); //description
    // $("#signPosting").before("<p class='citation'>" + exceptions.two.citation + "</p>"); //citation

    $(".tobaccoControlProgramFunding h2").after("<h5 class='subcategory'>" + exceptions.three.subcategory + "</h4>"+"<p class='description'>" + exceptions.three.description + "</p>"+"<p class='citation'>" + exceptions.three.citation + "</p>"); //subcategory
    // $(".tobaccoControlProgramFunding h2").after("<p class='description'>" + exceptions.three.description + "</p>"); //description
    // $(".tobaccoControlProgramFunding h2").after("<p class='citation'>" + exceptions.three.citation + "</p>"); //citation

    if( !$(".preemption").html().includes("<p") ){
      $(".preemption").hide();
    }

    fixCitations();
    fixCitationsPost();
  }

  var handleReject = function(err){
    document.getElementsByClassName("header-info-location js-location-modal")[0].click();
    throw "promise error:", err;
  }

  var runIt = function(){
    xmlSort()
      .then(handleResolve)
      .catch(handleReject)
  }

  $(document).ready(function() {
    runIt();
    $(".update-location").on("click", function(){
      $("#loadSpinner").css("display", "block");
      $(".info").hide();
      //console.log("zip changed");
      setTimeout(runIt, 1000);
    })
  });

</script>
